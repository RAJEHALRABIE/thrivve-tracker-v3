<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>تقرير حافز ثرايف - أسبوع واحد</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #0b1120;
        color: #e5e7eb;
        margin: 0;
        padding: 16px;
        direction: rtl;
      }
      .page {
        max-width: 900px;
        margin: 0 auto;
        background: #020617;
        border-radius: 18px;
        padding: 16px 18px;
        border: 1px solid rgba(148, 163, 184, 0.5);
      }
      h1,
      h2 {
        margin: 0 0 8px;
      }
      .meta {
        font-size: 13px;
        color: #9ca3af;
        margin-bottom: 10px;
      }
      .summary-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
        margin-bottom: 12px;
      }
      .summary-card {
        background: #020617;
        border-radius: 14px;
        padding: 8px 10px;
        border: 1px solid rgba(51, 65, 85, 0.9);
      }
      .summary-label {
        font-size: 12px;
        color: #9ca3af;
      }
      .summary-value {
        font-size: 16px;
        margin-top: 4px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
      }
      th,
      td {
        border: 1px solid rgba(31, 41, 55, 0.9);
        padding: 4px 5px;
        text-align: center;
      }
      thead {
        background: #020617;
      }
      tbody tr:nth-child(even) {
        background: rgba(15, 23, 42, 0.9);
      }
      .note {
        margin-top: 10px;
        font-size: 11px;
        color: #9ca3af;
      }
      @media print {
        body {
          background: #ffffff;
          color: #000000;
        }
        .page {
          border-radius: 0;
          border: none;
          padding: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <h1>تقرير أسبوع الحافز - متابع ثرايف</h1>
      <div id="meta" class="meta"></div>

      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-label">عدد الرحلات</div>
          <div id="sum-trips" class="summary-value">0</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">ساعات العمل (من مدة الرحلات)</div>
          <div id="sum-hours" class="summary-value">0.00</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">إجمالي الدخل من الرحلات (ر.س)</div>
          <div id="sum-income" class="summary-value">0.00</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">قيمة الحافز المتوقعة (ر.س)</div>
          <div id="sum-bonus" class="summary-value">0.00</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">نسبة وقت الذروة (من المدة)</div>
          <div id="sum-peak" class="summary-value">0.0%</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">نسبة زيادة الدخل التقريبية</div>
          <div id="sum-boost" class="summary-value">0.0%</div>
        </div>
      </div>

      <h2>تفاصيل الرحلات خلال فترة الحافز</h2>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>البداية</th>
            <th>النهاية</th>
            <th>المدة (دقيقة)</th>
            <th>قيمة الرحلة</th>
            <th>نوع الدفع</th>
            <th>كاش مستلم</th>
            <th>وقت ذروة؟</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="note">
        يمكن طباعة هذه الصفحة أو حفظها كملف PDF من خلال خيارات الطباعة في المتصفح، للاحتفاظ بسجل
        أسبوع الحافز.
      </div>
    </div>

    <script>
      function fmt(num, digits) {
        return Number(num || 0).toFixed(digits);
      }
      function formatDateTime(date) {
        const d = new Date(date);
        const ds = d.toLocaleDateString("en-GB", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric"
        });
        const ts = d.toLocaleTimeString("en-GB", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: true
        });
        return ds + " " + ts;
      }

      function parseDataFromHash() {
        try {
          const hash = window.location.hash;
          if (!hash.startsWith("#data=")) return null;
          const payload = decodeURIComponent(hash.slice("#data=".length));
          return JSON.parse(payload);
        } catch (e) {
          return null;
        }
      }

      const data = parseDataFromHash();
      if (!data) {
        document.getElementById("meta").textContent =
          "لم يتم تمرير بيانات من المتابع. افتح هذه الصفحة من خلال زر \"فتح صفحة التقرير\" داخل التطبيق.";
      } else {
        const state = data.state;
        const totals = data.totals;

        const start = new Date(state.weekStart);
        const end = new Date(state.weekEnd);
        const opts = { day: "2-digit", month: "2-digit", year: "numeric" };
        const rangeStr =
          start.toLocaleDateString("en-GB", opts) +
          " - " +
          end.toLocaleDateString("en-GB", opts);

        document.getElementById("meta").textContent =
          "فترة الحافز: " + rangeStr + " | تم إنشاء التقرير من متابع حافز ثرايف.";

        const bonusPerTrip = Number(state.settings.bonusPerTrip || 0);
        const expectedBonus = totals.tripCount * bonusPerTrip;
        const incomeBoostPercent =
          totals.totalFare > 0 ? (expectedBonus / totals.totalFare) * 100 : 0;

        document.getElementById("sum-trips").textContent = totals.tripCount;
        document.getElementById("sum-hours").textContent = fmt(totals.totalHours, 2);
        document.getElementById("sum-income").textContent = fmt(totals.totalFare, 2);
        document.getElementById("sum-bonus").textContent = fmt(expectedBonus, 2);
        document.getElementById("sum-peak").textContent = fmt(totals.peakPercent, 1) + "%";
        document.getElementById("sum-boost").textContent =
          fmt(incomeBoostPercent, 1) + "%";

        const tbody = document.getElementById("tbody");
        state.trips.forEach((t, i) => {
          const tr = document.createElement("tr");
          let payLabel = "-";
          if (t.paymentType === "cash") payLabel = "كاش";
          else if (t.paymentType === "card") payLabel = "بطاقة";
          else if (t.paymentType === "mixed") payLabel = "مختلط";
          tr.innerHTML =
            "<td>" +
            (i + 1) +
            "</td>" +
            "<td>" +
            formatDateTime(t.start) +
            "</td>" +
            "<td>" +
            formatDateTime(t.end) +
            "</td>" +
            "<td>" +
            fmt(t.durationMinutes, 1) +
            "</td>" +
            "<td>" +
            fmt(t.fare, 2) +
            "</td>" +
            "<td>" +
            payLabel +
            "</td>" +
            "<td>" +
            fmt(t.cashCollected, 2) +
            "</td>" +
            "<td>" +
            (t.isPeak ? "نعم" : "لا") +
            "</td>";
          tbody.appendChild(tr);
        });
      }
    </script>
  </body>
</html>
